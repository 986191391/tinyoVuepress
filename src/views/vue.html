<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Vue</title>
</head>
<style>
  * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
    user-select: none;
  }
</style>
<body>
  <div id="app" class="container">
    {{a}}<br>
    <span>{{b.b2}},</span><br>
    {{b.b1}}牛逼
  </div>
<script>
  function Vue(options) {
    this.$vm = this
    this.$options = options
    this.$data = options.data

    observe(this.$data)
    proxyData(this.$data, this)
    compile(options.el, this)
  }

  // function 

  function observe(data) {
    const dep = new Dep()
    for (let key in data) {
      let val = data[key]
      if (!!val && typeof val === 'object') observe(val)

      Object.defineProperty(data, key, {
        enumerable: true,
        configurable: true,
        get() {
          if (Dep.target) dep.addSubs(Dep.target)
          return val
        },
        set(newVal) {
          if (newVal === val) return
          val = newVal
          if (!!val && typeof val === 'object') observe(val)
          dep.notify()
        }
      })
    }
  }

  function proxyData(data, vm) {
    for(let key in data) {
      Object.defineProperty(vm, key, {
        enumerable: true,
        configurable: true,
        get() {
          return data[key]
        },
        set(newVal) {
          data[key] = newVal 
        }
      })
    }
  }

  function compile(el, vm) {
    vm.$el = document.querySelector(el)
    let fragment = document.createDocumentFragment()
    while(child = vm.$el.childNodes[0]) {
      fragment.appendChild(child)
    }
    elReplace(fragment.childNodes, vm)
    Array.from(fragment.childNodes).forEach((node) => {
      vm.$el.appendChild(node)
    })
  }

  function elReplace(fragmentNodes, vm) {
    Array.from(fragmentNodes).forEach((node, nodeIndex, arr) => {
      if (node.nodeType === 1) {
        elReplace(node.childNodes, vm)
        // 元素节点
      } else if (node.nodeType === 3) {
        // 文本节点
        const text = node.textContent
        let reg = /\{\{(.*)\}\}/
        const regExp = reg.test(text)
        if (!regExp) return
        // RegExp.$1 第一个匹配的xxx
        const dotArr = RegExp.$1.split('.')
        let newVal = vm
        dotArr.forEach((itm, idx) => {
          newVal = newVal[itm]
        })
        new Watcher(vm, RegExp.$1, function(newVal) {
          node.textContent = text.replace(reg, newVal)
        })
        node.textContent = text.replace(reg, newVal)
      }

    })
  }

  // 发布订阅
  function Dep() {
    this.subs = []
  }

  Dep.prototype.addSubs = function(watcher) {
    this.subs.push(watcher)
  }

  Dep.prototype.notify = function() {
    this.subs.forEach(sub => sub.update())
  }

  function Watcher(vm, exp, fn) {
    this.vm = vm
    this.exp = exp
    this.fn = fn
    Dep.target = this
    // 这里获取一下值是为了出发get方法
    let newVal = vm
    const dotArr = exp.split('.')
    dotArr.forEach((itm, idx) => {
      newVal = newVal[itm]
    })
    Dep.target = null
  }

  Watcher.prototype.update = function() {
    // 调用传入的fn方法，根据当前的环境变量来获取最新的值
    // 所以还要记录当前的环境变量

    let newVal = this.vm
    const dotArr = this.exp.split('.')
    dotArr.forEach((itm) => {
      newVal = newVal[itm]
    })
    this.fn(newVal)
  }

  let vue = new Vue({
    el: '#app',
    data: {
      a: '我是a。',
      b: {
        b1: '====bbbbb11111====',
        b2: 'b2'
      }
    }
  })

</script>
</body>
</html>
