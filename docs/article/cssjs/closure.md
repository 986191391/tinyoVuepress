# 闭包

[闭包 - 阮一峰](https://www.ruanyifeng.com/blog/2009/08/learning_javascript_closures.html)

如果经常去读别人的代码，就会发现闭包这东西基本都藏在每一个关键的知识点中。<br>
很多很牛杯的东西，基本都离不开闭包，而能不能发现他并运用在自己的项目中，成为衡量一个程序员是否成长的标准。

闭包是指函数和它所处的环境（定义时的作用域）一起组成的实体。简单来说，就是在一个函数内部声明的变量或函数可以被外部访问。

JavaScript 中的函数都有一个内部属性 [[Scope]]，用于存储这个函数所在的作用域链。当函数执行完毕后，其内部声明的变量仍然存在，只是无法被外部访问到，因为作用域链已经销毁了。如果要让函数内部变量持久化，我们就需要使用闭包。

使用闭包的方法是在一个函数内部再返回一个函数，这样就可以将内部变量保存下来了。如下例子：
```javascript
function add(x) {
  return function(y) {
    console.log(x+y);
  }
}

const add5 = add(5); // 接收一个参数x，并返回一个新函数
add5(3); // 在新函数中传递参数y
```
闭包可以帮助我们将函数相关的变量隐藏起来，避免变量被外部篡改，并且可以让我们在一定程度上模拟面向对象编程中的私有成员和方法。但是需要注意，当闭包引用的变量发生变化时，会影响到整个应用程序的执行效率和内存消耗，所以在使用闭包时应该谨慎权衡利弊。

### 变量的作用域
在一个作用域中使用了另一个作用域的变量，这是我对闭包最简单的一个表述。<br>
而在这当中最重要的就是`作用域`这个知识点。

变量的作用域无非就是两种：全局变量和局部变量。
```javascript

var cool = '全局变量'

function func() {
  var instr = '局部变量‘
  outstr = '全局变量' // 实际上声明了一个全局变量
}

```

### 在外部读取局部变量

```javascript
function f1(){
  var n = 999;

  return function() {
    alert(n)
  }
}

var result = f1()
result() // 999
```

通过以上的方法，在函数f1内定义一个子函数，子函数中引用函数内部的局部变量n，最后再将这个子函数返回。<br>
因为只有函数内部的子函数才能读取局部变量，因此可以把闭包简单理解成"定义在一个函数内部的函数"。在本质上，闭包就是将函数内部和函数外部连接起来的一座桥梁。

### 闭包案例

闭包可以用在许多地方。它的最大用处有两个，一个是前面提到的可以读取函数内部的变量，另一个就是让这些变量的值始终保持在内存中。闭包返回的变量不会在调用结束后，被垃圾回收机制（garbage collection）回收。所以不能滥用闭包，否则会造成网页的性能问题.

1. [防抖和节流](/csdn/utils/debounceThrottle.html)函数<br>
2. vue2双向绑定的原理，for in遍历data数据劫持的过程中，定义的变量取得的当前值也是通过闭包来保存，不会被清除， get/set时修改的也是该值。
3. 以下以前的写法
```javascript
for (var i = 0; i < 5; i++) {
  console.log('直接打印', i);
  (function(i) {
    setTimeout(() => { console.log('延迟打印', i) });
  })(i); // 包裹一层立即执行函数，创建一个作用域
}
```